version: "3.8"

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ğŸ³ UNIFIED DOCKER COMPOSE - SECURE + SIMPLE MODE             â•‘
# â•‘  Set DOCKER_MODE=simple in .env for basic setup               â•‘
# â•‘  Set DOCKER_MODE=secure (default) for Nginx + Fail2ban       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

x-app-environment: &app-environment
  NODE_ENV: production
  DATABASE_URL: mysql://${DB_USER:-ukk_user}:${DB_PASSWORD:-ukk_password}@db:3306/${DB_NAME:-ukk_db}
  NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost}
  NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
  NEXT_PUBLIC_FIREBASE_API_KEY: ${NEXT_PUBLIC_FIREBASE_API_KEY}
  NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
  NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
  NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
  NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
  NEXT_PUBLIC_FIREBASE_APP_ID: ${NEXT_PUBLIC_FIREBASE_APP_ID}
  NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
  NEXT_PUBLIC_FIREBASE_DATABASE_URL: ${NEXT_PUBLIC_FIREBASE_DATABASE_URL}
  FIREBASE_ADMIN_PROJECT_ID: ${FIREBASE_ADMIN_PROJECT_ID}
  FIREBASE_ADMIN_CLIENT_EMAIL: ${FIREBASE_ADMIN_CLIENT_EMAIL}
  FIREBASE_ADMIN_PRIVATE_KEY: ${FIREBASE_ADMIN_PRIVATE_KEY}
  NEXT_PUBLIC_VAPID_KEY: ${NEXT_PUBLIC_VAPID_KEY}

services:
  # MySQL Database
  db:
    image: mysql:8.0
    container_name: ukk_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-ukk_db}
      MYSQL_USER: ${DB_USER:-ukk_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-ukk_password}
    ports:
      # Only expose in simple mode
      - "${DB_PORT:-3307}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql-config/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
    networks:
      - backend_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Next.js Application
  app:
    build:
      context: .
      dockerfile: DockerFile
    container_name: ukk_app
    restart: unless-stopped
    environment:
      <<: *app-environment
    ports:
      # Only expose in simple mode, comment out for secure mode
      - "${APP_PORT:-3000}:3000"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - backend_network
      - frontend_network
    volumes:
      - ./prisma:/app/prisma
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy (Secure Mode Only)
  nginx:
    image: nginx:alpine
    container_name: ukk_nginx
    restart: unless-stopped
    profiles:
      - secure
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - frontend_network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - TZ=Asia/Jakarta

  # Fail2ban (Secure Mode Only)
  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: ukk_fail2ban
    restart: unless-stopped
    profiles:
      - secure
    environment:
      - TZ=Asia/Jakarta
      - F2B_LOG_LEVEL=INFO
      - F2B_DB_PURGE_AGE=30d
      - F2B_MAX_RETRY=5
      - F2B_DEST_EMAIL=${FAIL2BAN_EMAIL:-admin@localhost}
      - F2B_SENDER=${FAIL2BAN_SENDER:-fail2ban@localhost}
    volumes:
      - ./fail2ban/data:/data
      - ./fail2ban/config:/etc/fail2ban:ro
      - nginx_logs:/var/log/nginx:ro
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - nginx

volumes:
  mysql_data:
    driver: local
  nginx_cache:
    driver: local
  nginx_logs:
    driver: local

networks:
  # Frontend Network (Public-facing)
  frontend_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

  # Backend Network (Internal)
  backend_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
